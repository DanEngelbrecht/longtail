name: Validate PR

on:
  pull_request:
    branches: [ main ]

jobs:
  prep:
    runs-on: ubuntu-latest
    steps:
    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.9.1
      with:
        access_token: ${{ github.token }}

#  linux:
#
#    needs: prep
#
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#          include:
#            - config: "debug"
#              build_param: ""
#              exe_suffx: "debug"
#            - config: "release"
#              build_param: "release"
#              exe_suffix: ""
#
#    steps:
#    - uses: actions/checkout@v2
#    - name: build test
#      run: |
#        test/build.sh ${{ matrix.build_param }}
#    - name: build static_lib
#      run: |
#        static_lib/build.sh ${{ matrix.build_param }}
#    - name: build shared_lib
#      run: |
#        shared_lib/build.sh ${{ matrix.build_param }}
#    - name: build cmd
#      run: |
#        cmd/build.sh ${{ matrix.build_param }}
#    - name: run tests
#      run: |
#        pushd ./test
#        ../build/test${{ matrix.exe_suffix }}
#        popd
#
#  darwin:
#    needs: prep
#
#    runs-on: macos-latest
#
#    steps:
#    - uses: actions/checkout@v2
#    - name: build test
#      run: |
#        test/build.sh
#        test/build.sh release
#    - name: build static_lib
#      run: |
#        static_lib/build.sh
#        static_lib/build.sh release
#    - name: build shared_lib
#      run: |
#        shared_lib/build.sh
#        shared_lib/build.sh release
#    - name: build cmd
#      run: |
#        cmd/build.sh
#        cmd/build.sh release
#    - name: run tests
#      run: |
#        pushd ./test
#        ../build/test_debug
#        ../build/test
#        popd
#    - name: build dist
#      run: |
#        ./dist.sh
#    - uses: actions/upload-artifact@master
#      with:
#        name: dist-darwin-x64
#        path: dist

  win32-build:
    needs: prep

    runs-on: windows-latest
    strategy:
      matrix:
        config: [debug, release]
        target: [static_lib, shared_lib, cmd]

    steps:
    - uses: actions/checkout@v2
    - name: build ${{matrix.target}}
      run: |
        ${{matrix.target}}/build.bat ${{matrix.config}}

    - uses: actions/upload-artifact@v3
      name: upload ${{matrix.target}}
      with:
        name: artifacts-${{matrix.target}}-${{matrix.config}}
        path: |
          build/**
          !build/**/*.obj
          !build/**/*.o
          !build/**/third-party/**

  win32-test:
    needs: prep

    runs-on: windows-latest
    strategy:
      matrix:
        config: [debug, release]
    steps:
    - uses: actions/checkout@v2
    - name: build test
      run: |
        test/build.bat ${{matrix.config}}
    - name: run tests
      run: |
        cd ./test
        ../build/win32_x64/test/${{matrix.config}}/test.exe
        cd ..

  win32-dist:
    needs: win32-build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v3
      with:
        path: artifacts/
    - name: show downloaded artifacts
      run: |
        tree /f artifacts
    - name: copy artifacts
      run: |
        mkdir ./build
        cp -r ./artifacts-*/* ./build
    - name: show build artifacts
      run: |
        tree /f artifacts
    - name: build dist
      run: |
        ./dist.bat
    - uses: actions/upload-artifact@master
      with:
        name: dist-win32-x64
        path: dist

#    steps:
#    - name: build dist
#      run: |
#        ./dist.bat
#    - uses: actions/upload-artifact@master
#      with:
#        name: dist-win32-x64
#        path: dist
